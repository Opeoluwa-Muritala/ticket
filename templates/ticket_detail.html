<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Details - {{ ticket.ticket_id }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='ticket_detail.css') }}">
</head>
<body>
  <div class="container">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flash-messages">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="ticket-header">
      <h1>Ticket Details</h1>
      <a href="{{ url_for('view_tickets') }}" class="back-button">‚Üê Back to All Tickets</a>
    </div>
    
    <div class="ticket-info">
        <div class="info-section">
            <h2>Ticket ID: {{ ticket.ticket_id }}</h2>
            <span class="status-badge {{ ticket.status.lower() }}">{{ ticket.status }}</span>
        </div>
        
        <div class="info-grid">
            <div class="info-item">
                <label>Submitted By:</label>
                <span>{{ ticket.fullname }}</span>
            </div>
            <div class="info-item">
                <label>Account Number:</label>
                <span>{{ ticket.account_number }}</span>
            </div>
            <div class="info-item">
                <label>Email:</label>
                <span>{{ ticket.email }}</span>
            </div>
            <div class="info-item">
                <label>Reference:</label>
                <span>{{ ticket.reference or 'N/A' }}</span>
            </div>
            <div class="info-item">
                <label>Error Type:</label>
                <span>{{ ticket.error_type }}</span>
            </div>
            <div class="info-item">
                <label>Created At:</label>
                <span>{{ ticket.created_at }}</span>
            </div>
            <div class="info-item">
                <label>Closed At:</label>
                <span>{{ ticket.closed_at if ticket.closed_at else 'N/A' }}</span>
            </div>
        </div>

        <div class="description-section">
            <h3>Description</h3>
            <p>{{ ticket.description }}</p>
        </div>
        <div class="chat-history">
            <h3 style="margin-bottom: 20px;">Conversation History</h3>
            
            {% for msg in messages %}
                <div class="message {{ msg.sender_type }}">
                    <span class="message-sender">
                        {{ 'Support Team' if msg.sender_type == 'admin' else 'User' }}
                    </span>
                    
                    {{ msg.content }}
                    
                    <small class="message-time">{{ msg.created_at }}</small>
                </div>
            {% endfor %}
        
            {% if not messages %}
                <p style="text-align: center; color: #888;">No messages yet.</p>
            {% endif %}
        </div>
        
        <div class="reply-section" style="margin-top: 20px;">
            <h3>Reply to User</h3>
            <textarea id="admin-reply-text" style="width:100%; height:100px;"></textarea>
            <button onclick="sendAdminReply('{{ ticket.ticket_id }}')" style="background: blue; color: white; padding: 10px;">Send Reply</button>
        </div>
        
        <script>
        async function sendAdminReply(ticketId) {
            const text = document.getElementById('admin-reply-text').value;
            await fetch('/api/reply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    ticket_id: ticketId,
                    sender_type: 'admin',
                    message: text
                })
            });
            location.reload(); // Reload page to see message
        }
        </script>

        {% if ticket.file_path %}
        <div class="attachment-section" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
            <h3>Attachment</h3>
            
            {% if ticket.file_path.lower().endswith(('.jpg','.jpeg','.png')) %}
                <a href="{{ ticket.file_path }}" target="_blank">
                    <img src="{{ ticket.file_path }}" alt="Attachment" style="max-height: 400px; max-width: 100%; border-radius: 8px; border: 1px solid #ddd;">
                </a>
                <p><small>(Click image to view full size)</small></p>

            {% elif ticket.file_path.lower().endswith('.pdf') %}
                <embed src="{{ ticket.file_path }}" type="application/pdf" width="100%" height="500px" style="border: 1px solid #ddd;"/>
                <p style="margin-top:10px;"><a href="{{ ticket.file_path }}" target="_blank" style="color: blue; text-decoration: underline;">Open PDF in new tab</a></p>
            
            {% else %}
                <a href="{{ ticket.file_path }}" target="_blank" style="color: blue; text-decoration: underline;">Download Attachment</a>
            {% endif %}
        </div>
        {% endif %}
            
        <div class="actions-section" style="margin-top: 30px;">
            {% if ticket.status == "Open" %}
            <form action="{{ url_for('close_ticket', ticket_id=ticket.ticket_id) }}" method="POST" style="display:inline;">
                <button type="submit" class="close-button">Close Ticket</button>
            </form>
            {% endif %}
            
            <form action="{{ url_for('delete_ticket', ticket_id=ticket.ticket_id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this ticket?');" style="display:inline;">
                <button type="submit" class="delete-button">Delete Ticket</button>
            </form>
        </div>
    </div>
  </div>
</body>
</html>